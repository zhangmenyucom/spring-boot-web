<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.taylor.dao.RecmdStockDao">
    <resultMap id="BaseResultMap" type="com.taylor.entity.RecmdStock">
        <result column="id" property="id" jdbcType="BIGINT"/>
        <result column="stock_code" property="stockCode" jdbcType="VARCHAR"/>
        <result column="stock_name" property="stockName" jdbcType="VARCHAR"/>
        <result column="district" property="district" jdbcType="VARCHAR"/>
        <result column="current_price" property="currentPrice" jdbcType="DOUBLE"/>
        <result column="cost_price" property="costPrice" jdbcType="DOUBLE"/>
        <result column="record_price" property="recordPrice" jdbcType="DOUBLE"/>
        <result column="author_opinion" property="authorOpinion" jdbcType="VARCHAR"/>
        <result column="industry" property="industry" jdbcType="VARCHAR"/>
        <result column="majo_grow" property="majoGrow" jdbcType="DOUBLE"/>
        <result column="net_increase_rate" property="netIncreaseRate" jdbcType="DOUBLE"/>
        <result column="macd" property="macd" jdbcType="DOUBLE"/>
        <result column="kdj" property="kdj" jdbcType="VARCHAR"/>
        <result column="turnover_ratio" property="turnoverRatio" jdbcType="DOUBLE"/>
        <result column="liang_bi" property="liangbi" jdbcType="DOUBLE"/>
        <result column="liang_bi_today" property="liangbiToday" jdbcType="DOUBLE"/>
        <result column="main_in" property="mainIn" jdbcType="DOUBLE"/>
        <result column="main_in_bi" property="mainInBi" jdbcType="DOUBLE"/>
        <result column="outer_pan" property="outerPan" jdbcType="DOUBLE"/>
        <result column="inner_pan" property="innerPan" jdbcType="DOUBLE"/>
        <result column="change_ratio_yestoday" property="changeRatioYestoday" jdbcType="DOUBLE"/>
        <result column="change_ratio_today" property="changeRatioToday" jdbcType="DOUBLE"/>
        <result column="recmd_operate" property="recmdOperate" jdbcType="VARCHAR"/>
        <result column="kdj_count" property="kdjCount" jdbcType="INTEGER"/>
        <result column="strategy_type" property="strategyType" jdbcType="INTEGER"/>
        <result column="strategy" property="strategy" jdbcType="VARCHAR"/>
        <result column="score" property="score" jdbcType="DOUBLE"/>
        <result column="record_time" property="recordTime" jdbcType="VARCHAR"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
    </resultMap>
    <sql id="Base_Column_List">
        t.id,
        t.stock_code,
        t.stock_name,
        t.author_opinion,
        t.current_price,
        t.cost_price,
        t.record_price,
        d.industry,
        t.majo_grow,
        t.net_increase_rate,
        t.macd,
        t.kdj,
        t.turnover_ratio,
        t.liang_bi,
        t.liang_bi_today,
        t.main_in ,
        t.main_in_bi,
        t.outer_pan,
        t.inner_pan,
        t.change_ratio_yestoday,
        t.change_ratio_today,
        t.recmd_operate,
        t.kdj_count,
        t.strategy_type,
        t.strategy,
        t.score,
        t.record_time,
        t.update_time
    </sql>
    <select id="findByCondition" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>,d.district
        FROM recmd_stock t,stock_data d left join ( SELECT
        z.industry,count(z.industry) as in_num
        FROM recmd_stock s,stock_data z
        <where>
            <if test="query.id !=null">
                and id=#{query.id,jdbcType=BIGINT}
            </if>
            <if test="query.stockCode !=null">
                and stockCode=#{query.stockCode,jdbcType=VARCHAR}
            </if>
            <if test="query.stockName !=null">
                and stockName=#{query.stockName,jdbcType=VARCHAR}
            </if>
            <if test="query.macd !=null">
                and macd=#{query.macd,jdbcType=DOUBLE}
            </if>
            <if test="query.turnoverRatio !=null">
                and turnover_ratio=#{query.turnoverRatio,jdbcType=DOUBLE}
            </if>
            <if test="query.kdj !=null">
                and kdj=#{query.kdj,jdbcType=VARCHAR}
            </if>
            <if test="query.recmdOperate !=null">
                and recmd_operate=#{query.recmdOperate,jdbcType=VARCHAR}
            </if>
            <if test="query.strategy !=null">
                and strategy=#{query.strategy,jdbcType=VARCHAR}
            </if>
            <if test="query.strategyType !=null">
                and strategy_type=#{query.strategyType,jdbcType=INTEGER}
            </if>
            <if test="query.recordTime !=null">
                and day(record_time)=day(#{query.recordTime,jdbcType=TIMESTAMP})
            </if>
            and s.stock_code=z.stock_code
            GROUP BY z.industry
        </where>
        ) o on d.industry=o.industry

        <where>
            <if test="query.id !=null">
                and id=#{query.id,jdbcType=BIGINT}
            </if>
            <if test="query.stockCode !=null">
                and stockCode=#{query.stockCode,jdbcType=VARCHAR}
            </if>
            <if test="query.stockName !=null">
                and stockName=#{query.stockName,jdbcType=VARCHAR}
            </if>
            <if test="query.macd !=null">
                and macd=#{query.macd,jdbcType=DOUBLE}
            </if>
            <if test="query.turnoverRatio !=null">
                and turnover_ratio=#{query.turnoverRatio,jdbcType=DOUBLE}
            </if>
            <if test="query.kdj !=null">
                and kdj=#{query.kdj,jdbcType=VARCHAR}
            </if>
            <if test="query.recmdOperate !=null">
                and recmd_operate=#{query.recmdOperate,jdbcType=VARCHAR}
            </if>
            <if test="query.strategy !=null">
                and strategy=#{query.strategy,jdbcType=VARCHAR}
            </if>
            <if test="query.strategyType !=null">
                and strategy_type=#{query.strategyType,jdbcType=INTEGER}
            </if>
            <if test="query.recordTime !=null">
                and day(record_time)=day(#{query.recordTime,jdbcType=TIMESTAMP})
            </if>
            and t.stock_code=d.stock_code
        </where>
        order by o.in_num desc,industry desc,t.change_ratio_yestoday desc


    </select>
    <insert id="save" keyProperty="entity.id" keyColumn="id" useGeneratedKeys="true">
        INSERT INTO
        recmd_stock(stock_code,stock_name,record_price,cost_price,current_price,industry,majo_grow,net_increase_rate,macd,kdj,turnover_ratio,liang_bi,main_in,main_in_bi,outer_pan,inner_pan,change_ratio_yestoday,change_ratio_today,recmd_operate,kdj_count,strategy_type,strategy,record_time,update_time)
        VALUES (
        #{entity.stockCode,jdbcType=VARCHAR},
        #{entity.stockName,jdbcType=VARCHAR},
        #{entity.recordPrice,jdbcType=DOUBLE},
        #{entity.costPrice,jdbcType=DOUBLE},
        #{entity.currentPrice,jdbcType=DOUBLE},
        #{entity.industry,jdbcType=VARCHAR},
        #{entity.majoGrow,jdbcType=DOUBLE},
        #{entity.netIncreaseRate,jdbcType=DOUBLE},
        #{entity.macd,jdbcType=DOUBLE},
        #{entity.kdj,jdbcType=VARCHAR},
        #{entity.turnoverRatio,jdbcType=DOUBLE},
        #{entity.liangbi,jdbcType=DOUBLE},
        #{entity.mainIn,jdbcType=DOUBLE},
        #{entity.mainInBi,jdbcType=DOUBLE},
        #{entity.outerPan,jdbcType=DOUBLE},
        #{entity.innerPan,jdbcType=DOUBLE},
        #{entity.changeRatioYestoday,jdbcType=DOUBLE},
        #{entity.changeRatioToday,jdbcType=DOUBLE},
        #{entity.recmdOperate,jdbcType=VARCHAR},
        #{entity.kdjCount,jdbcType=INTEGER},
        #{entity.strategyType,jdbcType=INTEGER},
        #{entity.strategy,jdbcType=VARCHAR},
        NOW(),
        NOW()
        )
    </insert>

    <update id="update">
        UPDATE recmd_stock
        SET
        stock_code=#{entity.stockCode,jdbcType=VARCHAR}
        stock_name=#{entity.stockName,jdbcType=VARCHAR}
        macd=#{entity.macd,jdbcType=DOUBLE}
        WHERE id = #{entity.id,jdbcType=BIGINT}
    </update>

    <update id="updateRecmdTodayUpDownRatio">
        UPDATE recmd_stock
        SET
        change_ratio_today=#{stockBaseInfo.upDownMountPercent,jdbcType=DOUBLE},
        liang_bi_today=#{stockBaseInfo.liangBi,jdbcType=DOUBLE},
        current_price=#{stockBaseInfo.currentPrice,jdbcType=DOUBLE}
        WHERE stock_code = #{stockBaseInfo.stockCode,jdbcType=VARCHAR}
    </update>

    <select id="getByPrimaryKey" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM recmd_stock t
        WHERE t.id = #{id,jdbcType=BIGINT}
    </select>

    <select id="get" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM recmd_stock t
        WHERE id = #{entity.id,jdbcType=BIGINT}
    </select>

    <select id="getRecmdStockByCountTime" resultMap="BaseResultMap">
        SELECT
	    d.industry,r.*
        FROM
	    recmd_stock r
	    LEFT JOIN stock_data d on r.stock_code=d.stock_code
        LEFT JOIN
        (
            SELECT count(stock_code) AS count_num,stock_code
            FROM recmd_stock
            WHERE DAY (record_time) = DAY (#{recordTime})
            GROUP BY stock_code
        ) temp ON temp.stock_code = r.stock_code

        WHERE count_num >= 2
        AND DAY (r.record_time) = DAY (#{recordTime})
        ORDER BY count_num DESC,r.stock_name DESC,r.strategy_type DESC
    </select>

    <delete id="delByPrimaryKey">
        DELETE FROM recmd_stock
        WHERE id = #{id ,jdbcType=BIGINT}
    </delete>

    <delete id="del">
        DELETE FROM recmd_stock where 1=1
        and (date_add(now(),interval - 10 day) > record_time OR day(record_time)=day(NOW()))
        <if test="entity.strategyType!=null">
            and strategy_type = #{entity.strategyType}
        </if>
    </delete>

    <delete id="delByStrategyList">
        DELETE FROM recmd_stock where 1=1
        and (date_add(now(),interval - 10 day) > record_time OR day(record_time)=day(NOW()))
        <if test="strategyTypeList!=null">
            and strategy_type IN
            <foreach collection="strategyTypeList" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </delete>
</mapper>
